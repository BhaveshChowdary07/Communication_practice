<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ section.name }} - Practice</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/take_section.css') }}" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .layout-box {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .instruction-box, .question-box {
      flex: 1 1 48%;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 300px;
    }
    @media (max-width: 768px) {
      .layout-box {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="bg-light">
<div class="gradient-bg">
  <div class="container py-4">
    <h1 class="text-center mb-1">{{ section.name }}</h1>
    <p class="text-center text-muted mb-4">{{ section.description }}</p>

    <form method="POST">
      <input type="hidden" name="current_index" value="{{ current_index }}">
      {% set total = questions | length %}
      {% set q = questions[current_index] %}

      {% if section.type != 'essay_writing' %}
      <div class="layout-box mb-4">
        <!-- Instruction Box -->
        <div class="instruction-box">
          <h5 class="fw-semibold">Instructions</h5>
          <ul>
            {% if section.type == 'grammar' %}
              <li>Fill in the blank appropriately.</li>
            {% elif section.type == 'sentence_repeating' %}
              <li>Click 'Play Audio' to listen.</li>
              <li>Repeat the sentence aloud.</li>
              <li>Click 'Record Audio' to respond.</li>
            {% elif section.type == 'just_a_minute' %}
              <li>Click 'Play Audio' to hear the topic.</li>
              <li>Speak for 30‚Äì45 seconds.</li>
              <li>Click 'Record Audio' to start, then stop.</li>
            {% elif section.type == 'sentence_reading' %}
              <li>Read the given sentence aloud.</li>
              <li>Click 'Record Audio' to start, then stop.</li>
            {% endif %}
          </ul>
        </div>

        <!-- Question Box -->
        <div class="question-box">
          <h6 class="text-secondary mb-3">Question {{ current_index + 1 }} of {{ total }}</h6>
          {% if section.type == 'grammar' %}
            {% include 'grammar.html' %}
          {% elif section.type == 'sentence_reading' %}
            {% include 'sentence_reading.html' %}
          {% elif section.type == 'sentence_repeating' %}
            {% include 'sentence_repeating.html' %}
          {% elif section.type == 'just_a_minute' %}
            {% include 'just_a_minute.html' %}
          {% endif %}
        </div>
      </div>
      {% else %}
        {% include 'essay.html' %}
      {% endif %}

      <!-- Navigation Buttons -->
      <div class="d-flex justify-content-between mt-4">
        {% if current_index > 0 %}
          <button type="submit" name="prev" value="1" class="btn gradient-prev-btn" onclick="stopActiveRecording()">‚Üê Previous</button>
        {% else %}
          <div></div>
        {% endif %}
        {% if current_index + 1 == total %}
          <button type="submit" name="submit" value="1" class="btn gradient-submit-btn" id="submit-btn" onclick="stopActiveRecording()">Submit</button>
        {% else %}
          <button type="submit" name="next" value="1" class="btn gradient-next-btn" onclick="stopActiveRecording()">Next ‚Üí</button>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<!-- Recording & Utility Script -->
<script>
let mediaRecorder;
let audioChunks = [];
let activeBtn = null;

function toggleRecording(questionId, btn) {
  if (!mediaRecorder || mediaRecorder.state === 'inactive') {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        btn.innerText = "üéôÔ∏è Record Audio";
        btn.classList.remove("btn-secondary");
        btn.classList.add("btn-outline-danger");
        activeBtn = null;
      };

      mediaRecorder.start();
      btn.innerText = "‚èπ Stop Recording";
      btn.classList.remove("btn-outline-danger");
      btn.classList.add("btn-secondary");
      activeBtn = btn;
    });
  } else {
    mediaRecorder.stop();
  }
}

function stopActiveRecording() {
  if (mediaRecorder && mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
  }
}

function updateCharCount(textarea) {
  const count = textarea.value.length;
  const counter = document.getElementById("char-count");
  const submitBtn = document.getElementById("submit-btn");
  if (counter) counter.innerText = `Characters: ${count}/1000`;
  if (submitBtn) submitBtn.disabled = count === 0;
}

let isFormDirty = true;
window.onbeforeunload = function () {
  if (isFormDirty) {
    return "Are you sure you want to leave? Your response will be lost.";
  }
};

document.querySelector("form")?.addEventListener("submit", () => {
  isFormDirty = false;
});
</script>
</body>
</html>
