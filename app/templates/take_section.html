<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ section.name }} - Practice</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/grammar.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/essay.css') }}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .instruction-box,
        .question-box {
            flex: 1 1 48%;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .question-box {
            background: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }

        @media (max-width: 768px) {
            .instruction-box,
            .question-box {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body class="bg-light">
<div class="gradient-bg">
    <div class="container py-4">
        <h1 class="mb-1">{{ section.name }}</h1>
        <p class="text-muted mb-4">{{ section.description }}</p>

        <form method="POST">
            <input type="hidden" name="current_index" value="{{ current_index }}">
            {% set total = questions | length %}
            {% set q = questions[current_index] %}

            <div class="flex-container mb-4">
                <!-- Instructions -->
                <div class="instruction-box bg-light p-4 rounded">
                    <div>
                        <h4>Instructions</h4>
                        <ul>
                            {% if section.type == 'grammar' %}
                                <li>Fill in the blank appropriately.</li>
                            {% elif section.type == 'sentence_repeating' %}
                                <li>Click 'Play Audio' to listen</li>
                                <li>Repeat the sentence</li>
                                <li>Click 'Record Audio' and respond</li>
                                <li>Use 'Next' to go to the next question</li>
                            {% elif section.type == 'just_a_minute' %}
                                <li>Click 'Play Audio' to hear the topic</li>
                                <li>Speak for 30-45 seconds</li>
                                <li>Click 'Record Audio' to start, then stop</li>
                            {% elif section.type == 'sentence_reading' %}
                                <li>Read the given sentence aloud</li>
                                <li>Click 'Record Audio' to start, then stop</li>
                            {% endif %}
                        </ul>
                    </div>

                    {% if current_index > 0 %}
                        <button type="submit" name="prev" value="1" class="btn btn-outline-secondary mt-3">← Previous</button>
                    {% endif %}
                </div>

                <!-- Question Box -->
                <div class="question-box p-4 rounded">
                    <h6 class="text-secondary mb-2">Question {{ current_index + 1 }} of {{ total }}</h6>

                    {% if section.type in ['sentence_repeating', 'just_a_minute'] %}
                        <audio id="audio{{ q.id }}" controls>
                            <source src="{{ url_for('student_routes.get_question_audio', question_id=q.id) }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    {% elif section.type == 'sentence_reading' %}
                        <div class="sentence-box p-3 bg-light border">{{ q.question_text }}</div>
                    {% elif section.type == 'grammar' %}
                        <p>{{ q.question_text | safe }}</p>
                        <input type="text" name="grammar_answer_{{ q.id }}" class="form-control my-3" placeholder="Type your answer...">
                    {% endif %}

                    {% if section.type in ['sentence_reading', 'sentence_repeating', 'just_a_minute'] %}
                        <button type="button" class="btn btn-danger mt-3" onclick="toggleRecording('{{ q.id }}', this)">▶ Record Audio</button>
                        <div id="recording_{{ q.id }}" class="mt-2 text-muted">Not recording...</div>
                    {% endif %}

                    {% if current_index + 1 == total %}
                        <button type="submit" name="submit" value="1" class="btn btn-success mt-3">Submit</button>
                    {% else %}
                        <button type="submit" name="next" value="1" class="btn btn-primary mt-3">Next →</button>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let activeBtn = null;

function toggleRecording(questionId, btn) {
  if (!mediaRecorder || mediaRecorder.state === 'inactive') {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = audioUrl;
        const responseDiv = document.getElementById(`recording_${questionId}`);
        responseDiv.innerHTML = 'Recording complete:';
        responseDiv.appendChild(audio);
        btn.innerText = "▶ Record Audio";
        btn.classList.remove("btn-secondary");
        btn.classList.add("btn-danger");
        activeBtn = null;
      };

      mediaRecorder.start();
      const recordingDiv = document.getElementById(`recording_${questionId}`);
      recordingDiv.innerHTML = "<span class='text-danger fw-bold'>Recording...</span>";
      btn.innerText = "■ Stop Recording";
      btn.classList.remove("btn-danger");
      btn.classList.add("btn-secondary");
      activeBtn = btn;
    });
  } else if (mediaRecorder.state === 'recording') {
    mediaRecorder.stop();
  }
}

let isFormDirty = true;
window.onbeforeunload = function (e) {
  if (isFormDirty) {
    return "Are you sure you want to leave? Your response will be lost.";
  }
};
document.querySelector("form")?.addEventListener("submit", () => {
  isFormDirty = false;
});
</script>
</body>
</html>
